{% extends 'base.html' %}
{% load custom_filters %}
{% load humanize %}

{% block title %}Dashboard - RecoveryPro{% endblock %}

{% block content %}
<section class="py-10 bg-neutralGray min-h-screen">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Welcome Header -->
        <div class="mb-6 animate-fadeInUp">
            <div class="flex items-center justify-between flex-wrap gap-3">
                <div>
                    <h1 class="text-2xl sm:text-3xl font-bold text-midnight mb-1">
                        Welcome back, <span class="text-cyan">{{ user.first_name|default:user.username }}</span>! ðŸ‘‹
                    </h1>
                    <p class="text-coolGray text-sm sm:text-base">Here's an overview of your recovery progress</p>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="bg-white px-3 py-1.5 rounded-lg shadow-sm border border-gray-200">
                        <i class="far fa-calendar-alt text-cyan mr-1 text-xs"></i>
                        <span class="text-xs text-coolGray">{{ current_date|date:"M d, Y" }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Grid -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <!-- Total Cases Card -->
            <div class="bg-white p-4 rounded-xl shadow-card hover:shadow-lg transition group">
                <div class="flex items-start justify-between mb-3">
                    <div class="w-10 h-10 bg-midnight bg-opacity-10 rounded-lg flex items-center justify-center text-lg text-midnight group-hover:bg-midnight group-hover:text-white transition">
                        <i class="fas fa-folder-open"></i>
                    </div>
                    <div class="px-2 py-0.5 bg-midnight bg-opacity-5 rounded-full">
                        <span class="text-xs font-semibold text-midnight">Total</span>
                    </div>
                </div>
                <div>
                    <p class="text-coolGray text-xs mb-1 font-medium">Total Cases</p>
                    <p class="text-2xl font-bold text-midnight">{{ case_stats.total_cases|default:0 }}</p>
                    <div class="mt-2 flex items-center text-xs">
                        {% if case_stats.total_cases > 0 %}
                        <i class="fas fa-arrow-up text-green-500 mr-1 text-xs"></i>
                        <span class="text-green-500 font-semibold">Active</span>
                        {% else %}
                        <i class="fas fa-plus text-cyan mr-1 text-xs"></i>
                        <span class="text-cyan font-semibold">Start now</span>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Active Cases Card -->
            <div class="bg-white p-4 rounded-xl shadow-card hover:shadow-lg transition group">
                <div class="flex items-start justify-between mb-3">
                    <div class="w-10 h-10 bg-yellow-500 bg-opacity-10 rounded-lg flex items-center justify-center text-lg text-yellow-600 group-hover:bg-yellow-500 group-hover:text-white transition">
                        <i class="fas fa-hourglass-half"></i>
                    </div>
                    <div class="px-2 py-0.5 bg-yellow-500 bg-opacity-10 rounded-full">
                        <span class="text-xs font-semibold text-yellow-600">Active</span>
                    </div>
                </div>
                <div>
                    <p class="text-coolGray text-xs mb-1 font-medium">Active Cases</p>
                    <p class="text-2xl font-bold text-midnight">{{ case_stats.active_cases|default:0 }}</p>
                    <div class="mt-2 flex items-center text-xs">
                        {% if case_stats.active_cases > 0 %}
                        <div class="w-1.5 h-1.5 bg-yellow-500 rounded-full animate-pulse mr-2"></div>
                        <span class="text-coolGray">In progress</span>
                        {% else %}
                        <i class="fas fa-check text-green-500 mr-1 text-xs"></i>
                        <span class="text-coolGray">All caught up</span>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Recovered Amount Card -->
            <div class="bg-gradient-to-br from-green-500 to-green-600 p-4 rounded-xl shadow-card hover:shadow-lg transition text-white group">
                <div class="flex items-start justify-between mb-3">
                    <div class="w-10 h-10 bg-white bg-opacity-30 rounded-lg flex items-center justify-center text-lg group-hover:bg-white group-hover:text-green-500 transition">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="px-2 py-0.5 bg-white bg-opacity-30 rounded-full">
                        <span class="text-xs font-semibold text-white">Success</span>
                    </div>
                </div>
                <div>
                    <p class="text-white text-xs mb-1 font-medium opacity-90">Recovered Amount</p>
                    <p class="text-2xl font-bold text-white">{{ wallet.get_currency_symbol }}{{ case_stats.recovered_total|default:0|floatformat:2|intcomma }}</p>
                    <div class="mt-2 flex items-center text-xs text-white">
                        <i class="fas fa-trophy mr-1 text-xs"></i>
                        <span>
                            {% if case_stats.total_cases > 0 %}
                                {% widthratio case_stats.recovered_total case_stats.total_cases 1 as recovery_rate %}
                                Success: {{ recovery_rate }}%
                            {% else %}
                                Ready to recover
                            {% endif %}
                        </span>
                    </div>
                </div>
            </div>

            <!-- Wallet Balance Card -->
            <div class="bg-midnight p-4 rounded-xl shadow-card hover:shadow-lg transition group glow-effect border-2 border-cyan">
                <div class="flex items-start justify-between mb-3">
                    <div class="w-10 h-10 bg-cyan bg-opacity-20 rounded-lg flex items-center justify-center text-lg text-cyan group-hover:bg-cyan group-hover:text-white transition">
                        <i class="fas fa-wallet"></i>
                    </div>
                    {% if wallet.available_balance > 0 %}
                    <a href="{% url 'withdraw' %}" class="px-2 py-0.5 bg-cyan rounded-full hover:bg-cyanDark transition">
                        <span class="text-xs font-semibold text-white">Withdraw</span>
                    </a>
                    {% else %}
                    <div class="px-2 py-0.5 bg-gray-500 rounded-full">
                        <span class="text-xs font-semibold text-white">No funds</span>
                    </div>
                    {% endif %}
                </div>
                <div>
                    <p class="text-gray-300 text-xs mb-1 font-medium">Available Balance</p>
                    <p class="text-2xl font-bold text-white">{{ wallet.get_currency_symbol }}{{ wallet.available_balance|default:0|floatformat:2|intcomma }}</p>
                    <div class="mt-2 flex items-center text-xs text-gray-300">
                        <i class="fas fa-lock text-cyan mr-1 text-xs"></i>
                        <span>
                            {% if wallet.available_balance > 0 %}
                                Secured funds
                            {% else %}
                                No balance yet
                            {% endif %}
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Recent Cases - Left Side (2/3 width) -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Recent Cases Card -->
                <div class="bg-white p-4 sm:p-6 rounded-xl shadow-card">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg sm:text-xl font-bold text-midnight flex items-center">
                            <i class="fas fa-clipboard-list text-cyan mr-2 text-base"></i>Recent Cases
                        </h2>
                        {% if cases %}
                        <a href="{% url 'cases' %}" class="text-cyan font-semibold text-xs hover:text-cyanDark transition flex items-center">
                            View All <i class="fas fa-arrow-right ml-1 text-xs"></i>
                        </a>
                        {% endif %}
                    </div>
                    
                    {% if cases %}
                        <div class="space-y-3">
                            {% for case in cases %}
                                <a href="{% url 'case_detail' case.case_id %}" class="block p-3 sm:p-4 border-2 border-gray-100 rounded-lg hover:border-cyan hover:shadow-md transition group">
                                    <div class="flex justify-between items-start mb-2">
                                        <div class="flex items-start space-x-3 min-w-0 flex-1">
                                            <div class="w-9 h-9 bg-cyan bg-opacity-10 rounded-lg flex items-center justify-center text-cyan group-hover:bg-cyan group-hover:text-white transition flex-shrink-0">
                                                <i class="fas fa-file-alt text-sm"></i>
                                            </div>
                                            <div class="min-w-0 flex-1">
                                                <p class="font-bold text-midnight text-sm sm:text-base truncate">Case #{{ case.case_id }}</p>
                                                <p class="text-xs text-coolGray mt-0.5 line-clamp-1">{{ case.title }}</p>
                                            </div>
                                        </div>
                                        <span class="px-2 py-0.5 rounded-full text-xs font-bold flex-shrink-0 ml-2
                                            {% if case.status == 'completed' %}bg-green-100 text-green-700
                                            {% elif case.status == 'investigation' %}bg-yellow-100 text-yellow-700
                                            {% elif case.status == 'rejected' %}bg-red-100 text-red-700
                                            {% elif case.status == 'recovery' %}bg-blue-100 text-blue-700
                                            {% else %}bg-cyan bg-opacity-10 text-cyan{% endif %}">
                                            {{ case.get_status_display }}
                                        </span>
                                    </div>
                                    
                                    <div class="flex items-center justify-between mt-3 pt-3 border-t border-gray-100">
                                        <div class="flex items-center space-x-3 sm:space-x-4 text-xs">
                                            <span class="flex items-center text-coolGray">
                                                <i class="fas fa-dollar-sign text-cyan mr-1 text-xs"></i>
                                                <span class="font-semibold text-midnight">{{ wallet.get_currency_symbol }}{{ case.amount_lost|floatformat:2|intcomma }}</span>
                                            </span>
                                            <span class="hidden sm:flex items-center text-coolGray">
                                                <i class="far fa-calendar text-cyan mr-1 text-xs"></i>
                                                {{ case.incident_date|date:"M d, Y" }}
                                            </span>
                                        </div>
                                        <i class="fas fa-arrow-right text-cyan opacity-0 group-hover:opacity-100 transition text-xs"></i>
                                    </div>
                                    
                                    <!-- Progress Bar -->
                                    <div class="mt-3">
                                        <div class="flex items-center justify-between text-xs mb-1">
                                            <span class="text-coolGray text-xs">Progress</span>
                                            <span class="text-midnight font-bold text-xs">
                                                {% if case.status == 'completed' %}100
                                                {% elif case.status == 'recovery' %}75
                                                {% elif case.status == 'investigation' %}50
                                                {% elif case.status == 'verified' %}25
                                                {% else %}10{% endif %}%
                                            </span>
                                        </div>
                                        <div class="w-full bg-gray-200 rounded-full h-1.5">
                                            <div class="bg-gradient-cyan h-1.5 rounded-full transition-all" 
                                                 style="width: {% if case.status == 'completed' %}100
                                                 {% elif case.status == 'recovery' %}75
                                                 {% elif case.status == 'investigation' %}50
                                                 {% elif case.status == 'verified' %}25
                                                 {% else %}10{% endif %}%">
                                            </div>
                                        </div>
                                    </div>
                                </a>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-12">
                            <div class="w-20 h-20 bg-neutralGray rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-folder-open text-4xl text-coolGray"></i>
                            </div>
                            <p class="text-coolGray text-lg mb-2">No cases yet</p>
                            <p class="text-coolGray text-sm mb-6">Submit your first case to start the recovery process</p>
                            <a href="{% url 'new_case' %}" class="inline-block bg-gradient-cyan text-white px-6 py-3 rounded-lg font-bold hover:shadow-lg transition transform hover:scale-105">
                                <i class="fas fa-plus mr-2"></i>Submit Your First Case
                            </a>
                        </div>
                    {% endif %}
                </div>

                <!-- Activity Timeline -->
                <div class="bg-white p-6 rounded-2xl shadow-card">
                    <h3 class="text-xl font-bold text-midnight mb-6 flex items-center">
                        <i class="fas fa-history text-cyan mr-3"></i>Recent Activity
                    </h3>
                    <div class="space-y-4">
                        {% if cases %}
                            {% for case in cases|slice:":3" %}
                            <div class="flex items-start space-x-4">
                                <div class="w-10 h-10 bg-cyan bg-opacity-10 rounded-full flex items-center justify-center flex-shrink-0">
                                    <i class="fas fa-file-alt text-cyan"></i>
                                </div>
                                <div class="flex-1">
                                    <p class="text-sm font-semibold text-midnight">Case #{{ case.case_id }} Created</p>
                                    <p class="text-xs text-coolGray mt-1">{{ case.title }}</p>
                                    <p class="text-xs text-cyan mt-1">{{ case.created_at|timesince_simple }}</p>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-center py-8">
                                <i class="fas fa-clock text-4xl text-coolGray mb-3"></i>
                                <p class="text-coolGray text-sm">No recent activity</p>
                                <p class="text-coolGray text-xs mt-1">Submit a case to see activity here</p>
                            </div>
                        {% endif %}
                        
                        <!-- System Notifications -->
                        {% if notifications %}
                            {% for notif in notifications|slice:":2" %}
                            <div class="flex items-start space-x-4">
                                <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0">
                                    <i class="fas fa-bell text-green-600"></i>
                                </div>
                                <div class="flex-1">
                                    <p class="text-sm font-semibold text-midnight">{{ notif.title }}</p>
                                    <p class="text-xs text-coolGray mt-1">{{ notif.message|truncatewords:10 }}</p>
                                    <p class="text-xs text-cyan mt-1">{{ notif.created_at|timesince_simple }}</p>
                                </div>
                            </div>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Right Sidebar (1/3 width) -->
            <div class="space-y-6">
                <!-- Quick Actions Card -->
                <div class="bg-midnight text-white p-4 sm:p-5 rounded-xl shadow-card">
                    <h3 class="text-base sm:text-lg font-bold mb-4 flex items-center">
                        <i class="fas fa-bolt mr-2 text-cyan text-sm"></i>Quick Actions
                    </h3>
                    <div class="space-y-2">
                        <a href="{% url 'new_case' %}" class="block w-full bg-cyan text-white py-2.5 px-3 rounded-lg font-bold text-center hover:bg-cyanDark transition group shadow-lg text-sm transform hover:scale-105">
                            <i class="fas fa-plus mr-2 group-hover:scale-110 inline-block transition text-xs"></i>Submit New Case
                        </a>
                        
                        {% if wallet.available_balance > 0 %}
                        <a href="{% url 'withdraw' %}" class="block w-full bg-green-600 text-white py-2.5 px-3 rounded-lg font-bold text-center hover:bg-green-700 transition border-2 border-green-500 border-opacity-50 text-sm transform hover:scale-105">
                            <i class="fas fa-money-bill-wave mr-2 text-xs"></i>Withdraw {{ wallet.get_currency_symbol }}{{ wallet.available_balance|floatformat:2|intcomma }}
                        </a>
                        {% else %}
                        <div class="block w-full bg-gray-600 text-gray-300 py-2.5 px-3 rounded-lg font-bold text-center text-sm cursor-not-allowed">
                            <i class="fas fa-money-bill-wave mr-2 text-xs"></i>No funds to withdraw
                        </div>
                        {% endif %}
                        
                        {% if not user.is_kyc_verified %}
                        <a href="{% url 'kyc_verification' %}" class="block w-full bg-navy text-white py-2.5 px-3 rounded-lg font-bold text-center hover:bg-cyan transition border-2 border-cyan border-opacity-50 text-sm transform hover:scale-105">
                            <i class="fas fa-id-card mr-2 text-xs"></i>Verify KYC
                        </a>
                        {% else %}
                        <div class="block w-full bg-green-600 text-white py-2.5 px-3 rounded-lg font-bold text-center text-sm cursor-not-allowed">
                            <i class="fas fa-check-circle mr-2 text-xs"></i>KYC Verified
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Support Section -->
                    <div class="mt-4 pt-4 border-t border-cyan border-opacity-30">
                        <p class="text-gray-300 text-xs mb-2">Need help?</p>
                        <a href="{% url 'contact' %}" class="flex items-center text-white hover:text-cyan transition text-sm">
                            <i class="fas fa-headset mr-2 text-cyan text-xs"></i>
                            <span class="font-semibold">Contact Support</span>
                        </a>
                    </div>
                </div>

                <!-- Notifications Card -->
                <div class="bg-white p-6 rounded-2xl shadow-card">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-midnight flex items-center">
                            <i class="fas fa-bell text-cyan mr-2"></i>Notifications
                        </h3>
                        {% if notifications %}
                            <span class="w-6 h-6 bg-red-500 rounded-full flex items-center justify-center text-white text-xs font-bold">{{ notifications|length }}</span>
                        {% endif %}
                    </div>
                    
                    {% if notifications %}
                        <div class="space-y-3 max-h-80 overflow-y-auto custom-scrollbar">
                            {% for notif in notifications %}
                                <div class="p-4 bg-neutralGray rounded-xl border-l-4 border-cyan hover:shadow-md transition cursor-pointer" 
                                     onclick="markNotificationRead({{ notif.id }})">
                                    <div class="flex items-start justify-between mb-2">
                                        <p class="font-bold text-sm text-midnight">{{ notif.title }}</p>
                                        <span class="text-xs text-coolGray whitespace-nowrap ml-2">
                                            {{ notif.created_at|timesince_simple }}
                                        </span>
                                    </div>
                                    <p class="text-xs text-coolGray leading-relaxed">{{ notif.message|truncatewords:15 }}</p>
                                    {% if notif.related_case %}
                                    <div class="mt-2">
                                        <span class="inline-block bg-cyan bg-opacity-10 text-cyan text-xs px-2 py-1 rounded">
                                            Case #{{ notif.related_case.case_id }}
                                        </span>
                                    </div>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                        <a href="{% url 'notifications_list' %}" class="mt-4 inline-flex items-center text-cyan text-sm font-bold hover:text-cyanDark transition">
                            View All Notifications <i class="fas fa-arrow-right ml-2"></i>
                        </a>
                    {% else %}
                        <div class="text-center py-8">
                            <div class="w-16 h-16 bg-neutralGray rounded-full flex items-center justify-center mx-auto mb-3">
                                <i class="fas fa-bell-slash text-2xl text-coolGray"></i>
                            </div>
                            <p class="text-coolGray text-sm">No new notifications</p>
                            <p class="text-coolGray text-xs mt-1">You're all caught up!</p>
                        </div>
                    {% endif %}
                </div>

                <!-- Replace the Performance Card section with this corrected version -->
<div class="bg-white p-6 rounded-2xl shadow-card">
    <h3 class="text-xl font-bold text-midnight mb-6 flex items-center">
        <i class="fas fa-chart-line text-cyan mr-2"></i>Case Performance
    </h3>
    <div class="space-y-4">
        <!-- Case Completion Rate -->
        <div>
            <div class="flex items-center justify-between mb-2">
                <span class="text-sm text-coolGray font-medium">Case Completion</span>
                <span class="text-sm font-bold text-midnight">
                    {% if case_stats.total_cases > 0 %}
                        {% widthratio case_stats.completed_cases case_stats.total_cases 100 %}%
                    {% else %}
                        0%
                    {% endif %}
                </span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
                <div class="bg-green-500 h-2 rounded-full" 
                     style="width: {% if case_stats.total_cases > 0 %}{% widthratio case_stats.completed_cases case_stats.total_cases 100 %}%{% else %}0%{% endif %}">
                </div>
            </div>
            <p class="text-xs text-coolGray mt-1">
                {{ case_stats.completed_cases }} of {{ case_stats.total_cases }} cases resolved
            </p>
        </div>

        <!-- Recovery Efficiency -->
        <div>
            <div class="flex items-center justify-between mb-2">
                <span class="text-sm text-coolGray font-medium">Recovery Progress</span>
                <span class="text-sm font-bold text-midnight">
                    {% if case_stats.total_cases > 0 %}
                        {% widthratio case_stats.active_cases case_stats.total_cases 100 %}%
                    {% else %}
                        0%
                    {% endif %}
                </span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
                <div class="bg-cyan h-2 rounded-full" 
                     style="width: {% if case_stats.total_cases > 0 %}{% widthratio case_stats.active_cases case_stats.total_cases 100 %}%{% else %}0%{% endif %}">
                </div>
            </div>
            <p class="text-xs text-coolGray mt-1">
                {{ case_stats.active_cases }} cases in active recovery
            </p>
        </div>

        <!-- Success Rate -->
        <div>
            <div class="flex items-center justify-between mb-2">
                <span class="text-sm text-coolGray font-medium">Success Rate</span>
                <span class="text-sm font-bold text-midnight">
                    {% if case_stats.completed_cases > 0 %}
                        95%
                    {% else %}
                        0%
                    {% endif %}
                </span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
                <div class="bg-yellow-500 h-2 rounded-full" 
                     style="width: {% if case_stats.completed_cases > 0 %}95%{% else %}0%{% endif %}">
                </div>
            </div>
            <p class="text-xs text-coolGray mt-1">
                {% if case_stats.completed_cases > 0 %}
                    Industry-leading success
                {% else %}
                    No completed cases yet
                {% endif %}
            </p>
        </div>
    </div>
</div>
            </div>
        </div>
    </div>
</section>

<style>
.custom-scrollbar::-webkit-scrollbar {
    width: 6px;
}

.custom-scrollbar::-webkit-scrollbar-track {
    background: #F3F4F6;
    border-radius: 10px;
}

.custom-scrollbar::-webkit-scrollbar-thumb {
    background: #02B3E4;
    border-radius: 10px;
}

.custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background: #0195C4;
}

.line-clamp-1 {
    display: -webkit-box;
    -webkit-line-clamp: 1;
    -webkit-box-orient: vertical;
    overflow: hidden;
}
</style>

<script>
function markNotificationRead(notificationId) {
    // Mark notification as read via AJAX
    fetch(`/notifications/mark-read/${notificationId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'X-Requested-With': 'XMLHttpRequest'
        }
    }).then(response => {
        if (response.ok) {
            // Reload to update the notification count
            setTimeout(() => {
                window.location.reload();
            }, 300);
        }
    });
}

function markAllNotificationsRead() {
    fetch('{% url "mark_all_notifications_read" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'X-Requested-With': 'XMLHttpRequest'
        }
    }).then(response => {
        if (response.ok) {
            window.location.reload();
        }
    });
}
</script>
{% endblock %}