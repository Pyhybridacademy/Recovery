{% extends 'base.html' %}

{% block title %}Make Deposit - RecoveryPro{% endblock %}

{% block content %}
<section class="py-6 sm:py-8 bg-neutralGray min-h-screen">
    <div class="max-w-6xl mx-auto px-4">
        <!-- Header -->
        <div class="mb-8">
            <div class="flex items-center justify-between flex-wrap gap-4">
                <div>
                    <h1 class="text-2xl sm:text-3xl font-bold text-midnight mb-2">
                        Make Your <span class="text-cyan">Deposit</span>
                    </h1>
                    <p class="text-coolGray text-sm sm:text-base">
                        Case #{{ case.case_id }} • Required: <span class="font-bold text-cyan">{{ user.get_currency_symbol }}{{ deposit_amount }}</span>
                    </p>
                </div>
                <div class="flex items-center space-x-2 bg-yellow-50 border-2 border-yellow-400 px-4 py-2 rounded-lg">
                    <i class="fas fa-clock text-yellow-600"></i>
                    <span class="text-yellow-800 font-semibold text-sm">Awaiting Payment</span>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Main Deposit Form -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Step Indicator -->
                <div class="bg-white p-6 rounded-xl shadow-card">
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <div class="flex items-center">
                                <div class="w-10 h-10 bg-cyan rounded-full flex items-center justify-center text-white font-bold">
                                    1
                                </div>
                                <div class="ml-3">
                                    <p class="font-bold text-midnight text-sm">Select Crypto</p>
                                    <p class="text-coolGray text-xs">Choose your currency</p>
                                </div>
                            </div>
                        </div>
                        <i class="fas fa-arrow-right text-coolGray mx-4"></i>
                        <div class="flex-1">
                            <div class="flex items-center">
                                <div class="w-10 h-10 bg-gray-300 rounded-full flex items-center justify-center text-white font-bold">
                                    2
                                </div>
                                <div class="ml-3">
                                    <p class="font-bold text-midnight text-sm">Send Payment</p>
                                    <p class="text-coolGray text-xs">Transfer funds</p>
                                </div>
                            </div>
                        </div>
                        <i class="fas fa-arrow-right text-coolGray mx-4 hidden sm:block"></i>
                        <div class="flex-1 hidden sm:block">
                            <div class="flex items-center">
                                <div class="w-10 h-10 bg-gray-300 rounded-full flex items-center justify-center text-white font-bold">
                                    3
                                </div>
                                <div class="ml-3">
                                    <p class="font-bold text-midnight text-sm">Submit Proof</p>
                                    <p class="text-coolGray text-xs">Upload receipt</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Deposit Form -->
                <div class="bg-white p-6 sm:p-8 rounded-xl shadow-card">
                    <div class="flex items-center mb-6 pb-4 border-b-2 border-gray-100">
                        <i class="fas fa-wallet text-cyan text-2xl mr-3"></i>
                        <h2 class="text-xl font-bold text-midnight">Payment Information</h2>
                    </div>

                    <form method="post" enctype="multipart/form-data" class="space-y-6" id="depositForm">
                        {% csrf_token %}

                        <!-- Cryptocurrency Selection -->
                        <div>
                            <label for="id_crypto_currency" class="block text-sm font-bold text-midnight mb-2">
                                Select Cryptocurrency <span class="text-red-500">*</span>
                            </label>
                            <p class="text-xs text-coolGray mb-2">Choose which cryptocurrency you'll use for payment</p>
                            {{ form.crypto_currency }}
                            {% if form.crypto_currency.errors %}
                                <p class="text-red-500 text-xs mt-1">{{ form.crypto_currency.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <!-- Wallet Information (Shows after selection) -->
                        <div id="wallet-info" class="hidden">
                            <div class="bg-gradient-to-r from-cyan to-blue-500 bg-opacity-10 border-2 border-cyan rounded-xl p-6">
                                <div class="flex items-start justify-between mb-4">
                                    <div class="flex items-center">
                                        <div class="w-12 h-12 bg-cyan bg-opacity-20 rounded-full flex items-center justify-center mr-3">
                                            <i class="fas fa-qrcode text-cyan text-xl"></i>
                                        </div>
                                        <div>
                                            <p class="font-bold text-midnight text-lg">Send Payment To:</p>
                                            <p class="text-coolGray text-sm">Copy the address below</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bg-white rounded-lg p-4 mb-4 border-2 border-gray-200">
                                    <p class="text-xs text-coolGray mb-2 font-semibold">WALLET ADDRESS</p>
                                    <div class="flex items-center justify-between">
                                        <p id="wallet-address" class="font-mono text-sm text-midnight break-all flex-1 mr-4"></p>
                                        <button type="button" onclick="copyAddress()" 
                                                class="bg-cyan text-white px-4 py-2 rounded-lg font-semibold hover:bg-cyanDark transition flex-shrink-0 flex items-center">
                                            <i class="fas fa-copy mr-2"></i>Copy
                                        </button>
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div class="bg-white rounded-lg p-4 border-2 border-gray-200">
                                        <p class="text-xs text-coolGray mb-1 font-semibold">AMOUNT TO SEND</p>
                                        <p class="text-cyan font-bold text-lg">{{ user.get_currency_symbol }}{{ deposit_amount }}</p>
                                    </div>
                                    <div class="bg-white rounded-lg p-4 border-2 border-gray-200">
                                        <p class="text-xs text-coolGray mb-1 font-semibold">NETWORK</p>
                                        <p id="network-name" class="text-midnight font-bold text-lg">-</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Transaction Hash -->
                        <div>
                            <label for="id_transaction_hash" class="block text-sm font-bold text-midnight mb-2">
                                Transaction Hash/ID <span class="text-red-500">*</span>
                            </label>
                            <p class="text-xs text-coolGray mb-2">Enter the blockchain transaction hash after sending your payment</p>
                            {{ form.transaction_hash }}
                            {% if form.transaction_hash.errors %}
                                <p class="text-red-500 text-xs mt-1">{{ form.transaction_hash.errors.0 }}</p>
                            {% endif %}
                            <p class="text-xs text-coolGray mt-2 flex items-center">
                                <i class="fas fa-info-circle text-cyan mr-2"></i>
                                You can find this in your wallet's transaction history
                            </p>
                        </div>

                        <!-- Receipt Upload -->
                        <div>
                            <label for="id_receipt_proof" class="block text-sm font-bold text-midnight mb-2">
                                Payment Receipt/Proof <span class="text-red-500">*</span>
                            </label>
                            <p class="text-xs text-coolGray mb-2">Upload a screenshot of your transaction confirmation</p>
                            
                            <div class="border-2 border-dashed border-gray-300 rounded-xl p-6 text-center cursor-pointer hover:border-cyan transition-all duration-200" id="uploadZone">
                                {{ form.receipt_proof }}
                                <label for="id_receipt_proof" class="cursor-pointer block">
                                    <div class="w-16 h-16 bg-cyan bg-opacity-10 rounded-full flex items-center justify-center mx-auto mb-4">
                                        <i class="fas fa-cloud-upload-alt text-3xl text-cyan"></i>
                                    </div>
                                    <p class="text-midnight font-bold text-base mb-2">Click to Upload Receipt</p>
                                    <p class="text-coolGray text-sm">Screenshot of transaction confirmation</p>
                                    <div class="mt-4 flex items-center justify-center text-xs text-coolGray">
                                        <i class="fas fa-info-circle text-cyan mr-2"></i>
                                        <span>Supported: JPG, PNG, PDF • Max 10MB</span>
                                    </div>
                                </label>
                            </div>
                            
                            <div id="filePreview" class="mt-4 hidden">
                                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg border-2 border-gray-200">
                                    <div class="flex items-center space-x-4">
                                        <div class="w-10 h-10 bg-cyan bg-opacity-10 rounded-lg flex items-center justify-center">
                                            <i class="fas fa-file-image text-cyan text-lg"></i>
                                        </div>
                                        <div>
                                            <p id="fileName" class="font-semibold text-midnight text-sm"></p>
                                            <p id="fileSize" class="text-coolGray text-xs"></p>
                                        </div>
                                    </div>
                                    <button type="button" onclick="removeFile()" class="text-red-500 hover:text-red-700 transition">
                                        <i class="fas fa-times text-lg"></i>
                                    </button>
                                </div>
                            </div>
                            
                            {% if form.receipt_proof.errors %}
                                <p class="text-red-500 text-xs mt-1">{{ form.receipt_proof.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <!-- Important Notice -->
                        <div class="bg-yellow-50 border-2 border-yellow-400 rounded-xl p-6">
                            <div class="flex items-start">
                                <div class="w-10 h-10 bg-yellow-400 bg-opacity-20 rounded-full flex items-center justify-center flex-shrink-0 mr-4">
                                    <i class="fas fa-exclamation-triangle text-yellow-600 text-lg"></i>
                                </div>
                                <div>
                                    <p class="font-bold text-yellow-800 text-lg mb-3">Important Instructions</p>
                                    <ul class="space-y-2 text-sm text-yellow-900">
                                        <li class="flex items-start">
                                            <i class="fas fa-check-circle text-yellow-600 mr-2 mt-0.5"></i>
                                            <span>Send <strong>exactly</strong> the required amount ({{ user.get_currency_symbol }}{{ deposit_amount }})</span>
                                        </li>
                                        <li class="flex items-start">
                                            <i class="fas fa-check-circle text-yellow-600 mr-2 mt-0.5"></i>
                                            <span>Use the correct network for your selected cryptocurrency</span>
                                        </li>
                                        <li class="flex items-start">
                                            <i class="fas fa-check-circle text-yellow-600 mr-2 mt-0.5"></i>
                                            <span>Keep your transaction receipt for verification</span>
                                        </li>
                                        <li class="flex items-start">
                                            <i class="fas fa-check-circle text-yellow-600 mr-2 mt-0.5"></i>
                                            <span>Verification typically takes 1-2 hours after submission</span>
                                        </li>
                                        <li class="flex items-start">
                                            <i class="fas fa-check-circle text-yellow-600 mr-2 mt-0.5"></i>
                                            <span>Do not send additional funds to the same address</span>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 pt-2">
                            <button type="submit" class="bg-cyan text-white px-8 py-4 rounded-xl font-bold hover:bg-cyanDark transition-all duration-200 text-lg shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                                <i class="fas fa-paper-plane mr-3"></i>Submit Deposit Proof
                            </button>
                            <a href="{% url 'case_detail' case.id %}" class="border-2 border-gray-300 text-coolGray px-8 py-4 rounded-xl font-bold hover:border-cyan hover:text-cyan transition-all duration-200 text-center text-lg">
                                <i class="fas fa-arrow-left mr-3"></i>Back to Case
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="space-y-6">
                <!-- Case Details -->
                <div class="bg-white p-6 rounded-xl shadow-card">
                    <div class="flex items-center mb-4 pb-3 border-b-2 border-gray-100">
                        <i class="fas fa-info-circle text-cyan text-xl mr-2"></i>
                        <h3 class="font-bold text-midnight">Deposit Details</h3>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <p class="text-coolGray text-xs font-semibold mb-1">CASE ID</p>
                            <p class="font-bold text-midnight">#{{ case.case_id }}</p>
                        </div>
                        <div>
                            <p class="text-coolGray text-xs font-semibold mb-1">REQUIRED AMOUNT</p>
                            <p class="font-bold text-2xl text-cyan">{{ user.get_currency_symbol }}{{ deposit_amount }}</p>
                        </div>
                        <div>
                            <p class="text-coolGray text-xs font-semibold mb-1">PAYMENT STATUS</p>
                            <span class="inline-flex items-center px-3 py-1.5 rounded-full bg-yellow-100 text-yellow-800 text-sm font-semibold">
                                <i class="fas fa-clock mr-2"></i>Awaiting Payment
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Security Features -->
                <div class="bg-white p-6 rounded-xl shadow-card">
                    <div class="flex items-center mb-4 pb-3 border-b-2 border-gray-100">
                        <i class="fas fa-shield-alt text-cyan text-xl mr-2"></i>
                        <h3 class="font-bold text-midnight">Security & Protection</h3>
                    </div>
                    <ul class="space-y-3 text-sm">
                        <li class="flex items-start">
                            <div class="w-6 h-6 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0 mr-3 mt-0.5">
                                <i class="fas fa-check text-green-600 text-xs"></i>
                            </div>
                            <span class="text-midnight">Escrow protected funds</span>
                        </li>
                        <li class="flex items-start">
                            <div class="w-6 h-6 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0 mr-3 mt-0.5">
                                <i class="fas fa-check text-green-600 text-xs"></i>
                            </div>
                            <span class="text-midnight">256-bit SSL encryption</span>
                        </li>
                        <li class="flex items-start">
                            <div class="w-6 h-6 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0 mr-3 mt-0.5">
                                <i class="fas fa-check text-green-600 text-xs"></i>
                            </div>
                            <span class="text-midnight">Verified recovery agents</span>
                        </li>
                        <li class="flex items-start">
                            <div class="w-6 h-6 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0 mr-3 mt-0.5">
                                <i class="fas fa-check text-green-600 text-xs"></i>
                            </div>
                            <span class="text-midnight">Money-back guarantee</span>
                        </li>
                    </ul>
                </div>

                <!-- Next Steps -->
                <div class="bg-gradient-to-br from-cyan to-blue-500 p-6 rounded-xl shadow-card text-white">
                    <div class="flex items-center mb-4">
                        <i class="fas fa-list-check text-2xl mr-3"></i>
                        <h3 class="font-bold text-lg">Next Steps</h3>
                    </div>
                    <ol class="space-y-3 text-sm">
                        <li class="flex items-start">
                            <span class="w-6 h-6 bg-white bg-opacity-20 rounded-full flex items-center justify-center flex-shrink-0 mr-3 font-bold text-xs">1</span>
                            <span>Select your preferred cryptocurrency</span>
                        </li>
                        <li class="flex items-start">
                            <span class="w-6 h-6 bg-white bg-opacity-20 rounded-full flex items-center justify-center flex-shrink-0 mr-3 font-bold text-xs">2</span>
                            <span>Copy the wallet address provided</span>
                        </li>
                        <li class="flex items-start">
                            <span class="w-6 h-6 bg-white bg-opacity-20 rounded-full flex items-center justify-center flex-shrink-0 mr-3 font-bold text-xs">3</span>
                            <span>Send payment from your crypto wallet</span>
                        </li>
                        <li class="flex items-start">
                            <span class="w-6 h-6 bg-white bg-opacity-20 rounded-full flex items-center justify-center flex-shrink-0 mr-3 font-bold text-xs">4</span>
                            <span>Paste the transaction hash here</span>
                        </li>
                        <li class="flex items-start">
                            <span class="w-6 h-6 bg-white bg-opacity-20 rounded-full flex items-center justify-center flex-shrink-0 mr-3 font-bold text-xs">5</span>
                            <span>Upload your payment receipt</span>
                        </li>
                        <li class="flex items-start">
                            <span class="w-6 h-6 bg-white bg-opacity-20 rounded-full flex items-center justify-center flex-shrink-0 mr-3 font-bold text-xs">6</span>
                            <span>Wait for confirmation (1-2 hours)</span>
                        </li>
                    </ol>
                </div>

                <!-- Support -->
                <div class="bg-white p-6 rounded-xl shadow-card border-2 border-gray-200">
                    <div class="text-center">
                        <div class="w-12 h-12 bg-cyan bg-opacity-10 rounded-full flex items-center justify-center mx-auto mb-3">
                            <i class="fas fa-headset text-cyan text-xl"></i>
                        </div>
                        <h3 class="font-bold text-midnight mb-2">Need Help?</h3>
                        <p class="text-coolGray text-sm mb-4">Our support team is here 24/7</p>
                        <a href="{% url 'contact' %}" class="text-cyan hover:text-cyanDark font-semibold text-sm flex items-center justify-center">
                            <i class="fas fa-arrow-right mr-2"></i>Contact Support
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<style>
/* Form Input Styles */
input[type="text"],
input[type="file"],
select {
    width: 100%;
    padding: 0.875rem 1rem;
    border: 2px solid #E5E7EB;
    border-radius: 0.5rem;
    color: #0A1A2F;
    background-color: white;
    transition: all 0.2s ease;
    outline: none;
    font-size: 0.875rem;
}

input[type="text"]::placeholder {
    color: #9CA3AF;
}

input[type="text"]:hover,
select:hover {
    border-color: #D1D5DB;
}

input[type="text"]:focus,
select:focus {
    border-color: #02B3E4;
    box-shadow: 0 0 0 3px rgba(2, 179, 228, 0.1);
}

/* Select dropdown styling */
select {
    appearance: none;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 0.75rem center;
    background-size: 1.5rem 1.5rem;
    padding-right: 2.5rem;
}

/* Hide file input */
#id_receipt_proof {
    display: none;
}

/* Upload zone hover effect */
#uploadZone:hover {
    border-color: #02B3E4;
    background-color: rgba(2, 179, 228, 0.02);
}

/* Animation for wallet info */
#wallet-info {
    animation: fadeInUp 0.5s ease-out;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
</style>

<script>
// Cryptocurrency wallet addresses
const wallets = {
    {% for wallet in crypto_wallets %}
        '{{ wallet.currency }}': {
            address: '{{ wallet.wallet_address }}',
            network: '{{ wallet.currency }}'
        },
    {% endfor %}
};

// Handle cryptocurrency selection
document.querySelector('[name="crypto_currency"]').addEventListener('change', function() {
    const selectedCrypto = this.value;
    const walletInfo = document.getElementById('wallet-info');
    const walletAddress = document.getElementById('wallet-address');
    const networkName = document.getElementById('network-name');
    
    if (selectedCrypto && wallets[selectedCrypto]) {
        walletAddress.textContent = wallets[selectedCrypto].address;
        networkName.textContent = wallets[selectedCrypto].network;
        walletInfo.classList.remove('hidden');
        
        // Scroll to wallet info smoothly
        setTimeout(() => {
            walletInfo.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }, 100);
    } else {
        walletInfo.classList.add('hidden');
    }
});

// Copy wallet address to clipboard
function copyAddress() {
    const address = document.getElementById('wallet-address').textContent;
    navigator.clipboard.writeText(address).then(() => {
        // Show success feedback
        const button = event.target.closest('button');
        const originalHTML = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check mr-2"></i>Copied!';
        button.classList.add('bg-green-500');
        button.classList.remove('bg-cyan');
        
        setTimeout(() => {
            button.innerHTML = originalHTML;
            button.classList.remove('bg-green-500');
            button.classList.add('bg-cyan');
        }, 2000);
    }).catch(err => {
        alert('Failed to copy address. Please copy manually.');
    });
}

// File upload preview
const fileInput = document.getElementById('id_receipt_proof');
const filePreview = document.getElementById('filePreview');
const fileName = document.getElementById('fileName');
const fileSize = document.getElementById('fileSize');

if (fileInput) {
    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            // Check file size (10MB max)
            if (file.size > 10 * 1024 * 1024) {
                alert('File is too large. Maximum size is 10MB.');
                this.value = '';
                return;
            }
            
            // Check file type
            const validTypes = ['image/jpeg', 'image/png', 'image/jpg', 'application/pdf'];
            if (!validTypes.includes(file.type)) {
                alert('Invalid file type. Please upload JPG, PNG, or PDF.');
                this.value = '';
                return;
            }
            
            // Show preview
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            filePreview.classList.remove('hidden');
        }
    });
}

function removeFile() {
    fileInput.value = '';
    filePreview.classList.add('hidden');
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i];
}

// Form validation
document.getElementById('depositForm').addEventListener('submit', function(e) {
    const cryptoCurrency = document.querySelector('[name="crypto_currency"]').value;
    const transactionHash = document.querySelector('[name="transaction_hash"]').value;
    const receiptProof = fileInput.files.length;
    
    if (!cryptoCurrency) {
        e.preventDefault();
        alert('Please select a cryptocurrency');
        document.querySelector('[name="crypto_currency"]').focus();
        return;
    }
    
    if (!transactionHash.trim()) {
        e.preventDefault();
        alert('Please enter the transaction hash');
        document.querySelector('[name="transaction_hash"]').focus();
        return;
    }
    
    if (!receiptProof) {
        e.preventDefault();
        alert('Please upload your payment receipt');
        fileInput.focus();
        return;
    }
});
</script>
{% endblock %}